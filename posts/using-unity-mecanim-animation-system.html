<!DOCTYPE html>
<html lang="en">
<head>
          <title>Ha.Minh's Blog</title>
        <meta charset="utf-8" />
        <link href="http://minhhh.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Ha.Minh's Blog Full Atom Feed" />
        <link href="http://minhhh.github.io/feeds/unity.atom.xml" type="application/atom+xml" rel="alternate" title="Ha.Minh's Blog Categories Atom Feed" />



    <meta name="tags" contents="unity" />
    <meta name="tags" contents="mecanim" />

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://minhhh.github.io/">Ha.Minh's Blog <strong>Software development and other stuff</strong></a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li><a href="http://minhhh.github.io/pages/about">About</a></li>
            <li><a href="http://minhhh.github.io/pages/projects">Projects</a></li>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="http://minhhh.github.io/posts/using-unity-mecanim-animation-system" rel="bookmark"
         title="Permalink to Using Unity Mecanim animation system">Using Unity Mecanim animation system</a></h2>
 
  </header>
  <footer class="post-info">
    <abbr class="published" title="2017-01-02T00:00:00">
      Mon 02 January 2017
    </abbr>
    <address class="vcard author">
      By           <a class="url fn" href="http://minhhh.github.io/author/haminh.html">Ha.Minh</a>
    </address>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <p>See <a href="https://github.com/minhhh/unity-mecanim.git">unity-mecanim</a> for sample code of this article</p>
<h2>Mechanim basics</h2>
<ul>
<li><a href="https://www.youtube.com/watch?v=wdOk5QXYC6Y">Unity 5 Tutorial - Animation Control</a></li>
<li><a href="https://www.youtube.com/watch?v=7-OUZecgXv0">Unity Third Person Control: Mecanim Nodes - Tutorial 5</a></li>
<li><a href="https://community.mixamo.com/hc/en-us/articles/203879268">Unity: Mecanim Animation Basics</a></li>
<li><a href="http://docs.unity3d.com/Manual/animeditor-UsingAnimationEditor.html">Animation Editor</a></li>
<li><a href="http://docs.unity3d.com/Manual/AnimationSoloMute.html">Solo and mute</a></li>
</ul>
<h3><a href="http://docs.unity3d.com/Manual/AnimationParameters.html">animation parameters</a></h3>
<ul>
<li>Animation Parameters are variables that are defined within an Animator Controller that can be accessed and assigned values from scripts. This is how a script can control or affect the flow of the state machine.</li>
<li>Parameters can be assigned values from a script using functions in the Animator class: SetFloat, SetInt, SetBool, SetTrigger and ResetTrigger</li>
<li><a href="http://answers.unity3d.com/questions/600268/mecanim-animation-parameter-types-boolean-vs-trigg.html">Mecanim Animation Parameter Types: Boolean vs. Trigger</a></li>
<li>Parameters can also be controlled in animation using Curve and read in script<ul>
<li>You cannot control an Animation parameter from both Curve and Script, so you have to structure your code correspondingly.</li>
</ul>
</li>
</ul>
<h3>Root motion, Blend Tree</h3>
<ul>
<li><a href="https://www.youtube.com/watch?v=k12w-rEbuXI&amp;index=1&amp;list=PL_eGgISVYZkeD-q83hLtPESTB-lPKnfjH">RPG Character Controller 001 - Unity 5 Root Motion</a></li>
</ul>
<h3>Layer, Layer Mask</h3>
<ul>
<li>Layer Usages (<a href="https://unity3d.com/learn/tutorials/topics/animation/animator-controller-layers">Animator Controller Layers</a>)<ul>
<li>Additional layer for handling different body parts while the base layer handles the base movement, such as: wave hand while moving</li>
<li>Blending mode can be: Override or Additive. Normally <code>Override</code> will be used because using <code>Additive</code> can be highly unpredictable unless you're an advanced animator. (<a href="https://community.mixamo.com/hc/en-us/articles/204581427-Unity-Mecanim-Advanced-Animation">advanced animation</a>)</li>
<li>Blend additional movement based on character state such as: heavy breathing when tired</li>
<li>Sync layer when you have a set of animation for when the character state changes such as: wounded animations</li>
</ul>
</li>
<li>Avatar Mask(<a href="https://unity3d.com/learn/tutorials/topics/animation/avatar-masks">Avatar Masks</a>)<ul>
<li>Could be set in animation to see the effect of Masking only part of the body</li>
<li>Normally apply to layer which controls part of the body (<a href="https://community.mixamo.com/hc/en-us/articles/204581427-Unity-Mecanim-Advanced-Animation">advanced animation</a>)</li>
</ul>
</li>
</ul>
<h3>Equip weapon</h3>
<ul>
<li>Equip immediately without animation<ul>
<li>For models created in Unity<ul>
<li>Create weapon holder node</li>
<li>Attach the weapons to it</li>
<li>Hide/Unhide the correct weapon when switching weapon</li>
</ul>
</li>
<li>For models created outside Unity<ul>
<li>Find the correct node in the model OR create a weapon holder node like before</li>
<li>Attach the weapons to it</li>
<li>Hide/Unhide the correct weapon when switching weapon</li>
</ul>
</li>
</ul>
</li>
<li>Equip with equip/unequip animations. All weapons are treated the same when equipped (<a href="https://www.youtube.com/watch?v=7gsl43thTsk">Sword equipping</a>)<ul>
<li>Create equip/unequip animation for each weapons</li>
<li>Using layer/layer mask to blend the equip/unequip animations, masking only the necessary parts of the body, such as the arm movement</li>
<li>Using Animation Event to set value to flags such as: sword_equipped, sword_unequipped</li>
<li>Attach the corresponding weapon using Animation Event calling functions and/or flags</li>
</ul>
</li>
<li>Weapons affect whole animation when equiped (<a href="https://www.youtube.com/watch?v=Is9C4i4XyXk">Applied Mecanim : Character Animation and Combat State Machines</a>)</li>
</ul>
<h3>Using mechanim as state machine</h3>
<ul>
<li><a href="http://forum.unity3d.com/threads/mecanim-as-generic-state-machine.311201/">Mecanim as generic state machine</a></li>
<li><a href="http://pekalicious.com/blog/unity3d-reusing-animator-controllers-with-animatoroverridecontroller/">Reusing animator controllers with AnimatorOverrideController</a></li>
<li><a href="https://www.youtube.com/watch?v=Is9C4i4XyXk">Applied Mecanim : Character Animation and Combat State Machines</a><ul>
<li>A character with<ul>
<li>8 weapon types<ul>
<li>9-12 ground attacks</li>
<li>5 aerial attacks</li>
<li>3 defensive maneuvers</li>
</ul>
</li>
<li>4 throwable items</li>
<li>6 classes of magic each with 3-6 abilities</li>
<li>Basic locomotion, jump, hit react, death</li>
</ul>
</li>
<li>One way is to use SubStateMachine, with several depth layers</li>
<li>An alternative organization is to use BaseLayer with Overrides Layer and Additive Layer</li>
</ul>
</li>
<li><a href="https://www.youtube.com/watch?v=HOURak6BpSo">Leveraging Unity 5.2's Advanced Animation Features</a><ul>
<li>You can manage all transitions between attacks manually</li>
<li>Or you can use a blend tree. This is slightly better. One problem is if you change the Blend parameter while playing animation, it will change the animation immediately.</li>
<li>Solution in Unity 5: StateMachineBehaviour on a State. This way you can have code that run at the Start or End of your blendtree.</li>
<li>You could also have StateMachineBehaviour on a StateMachine. Then you can override <code>OnStateMachineEnter</code> and <code>OnStateMachineExit</code> functions</li>
<li>When the SubStateMachine is a sequence of animations, you can have code on <code>OnStateMachineEnter</code> to equip weapon</li>
<li>Can also check for Input in <code>StateMachineBehaviour</code></li>
</ul>
</li>
</ul>
<h2>Best Practices</h2>
<ul>
<li>
<p><a href="http://answers.unity3d.com/questions/806949/animation-events-not-firing.html">Animation events not firing</a> when the event is near the endframe, so either use a third party event dispatcher, or use <code>StateMachineBehaviour</code>.</p>
</li>
<li>
<p>Use custom class to cache animation event</p>
<ul>
<li>You might catch animation events using a general event handler function such as <code>OnAnimationEvent (AnimationEvent)</code>, however this might not be the best solution since you will have to do a switch case in your main logic class. This will make the main logic class (e.g. Enemy, Player) knows too much about the flow to handle animation event. Also you might not be able to reuse common code.</li>
<li>A better way is to have a generic custom class to handle animation event, e.g. <code>AnimatorHandler</code>. This class will have most common function such as <code>OnAnimationStart</code>, <code>OnAnimationEnd</code>, <code>OnAnimationUpdate</code>. You can pass custom handle functions in as callback if you need to. This class also has common utility function such as getting current state name, check if any animation is playing etc.</li>
</ul>
</li>
<li>
<p>When importing animations, make sure to <code>Bake into pose</code> the part where you don't want to move by Root motion. Also use <code>Offset</code> to fix Average velocity not zero problems, e.g. walking animation that has a X speed</p>
</li>
<li>
<p>Change the animation speed of specific layer</p>
<ul>
<li>There's no way to change the animation speed of specific layer. The current best way is to Use blend tree to control the speed of a particular layer based on parameter. See <a href="http://forum.unity3d.com/threads/mecanim-change-animation-speed-of-specific-animation-or-layers.160395/">Mecanim - Change animation speed of specific animation or layers</a></li>
<li>You can also change the speed of particular state in Editor and via script</li>
</ul>
</li>
<li>Use int parameter instead of boolean or trigger. This way you can use AnyState to transition using condition such as <code>skill=1</code>, then when entering the mecanim state we set it to another number immediately <a href="https://www.youtube.com/watch?v=Is9C4i4XyXk">Applied Mecanim : Character Animation and Combat State Machines</a></li>
<li>Use substate to simplify your state machine. However, becareful when constructing AnyState transition to deeper substate, since AnyState is global. In this way, we can ignore the immediate substate and only care about the final subtate. We use the most specific condition, such as <code>skill=1 and subskill=2</code> to trigger the final substate from AnyState. This way we don't have to configure transition to immediate substate and only care about the final state</li>
<li>Use SMB: <a href="https://www.youtube.com/watch?v=Is9C4i4XyXk">Applied Mecanim : Character Animation and Combat State Machines</a><ul>
<li><code>SMB</code> makes sure that <code>OnStateMachineExit</code> is called when exiting a state. Putting a animation event at the end of an animation cannot ensure that for 2 reasons: The animation might be forced to switch in the middle or the animation event might not fire because the animation is played too quickly</li>
</ul>
</li>
<li>
<p><a href="http://answers.unity3d.com/questions/685968/running-an-animation-completely-before-transitioni.html">Running an animation completely before transitioning back</a></p>
<ul>
<li>Make sure Exit time is 1.00, with FixedDuration unchecked.</li>
</ul>
</li>
<li>
<p>How to Run the death animation then destroy GameObject</p>
<ul>
<li>Use a timer. This is quite a robust solution but maybe not visually correct in some cases, i.e. the animation might be stopped too soon.</li>
<li>Use animation event. Add an Exit event to the animation at the last frame. This is not very robust, since Unity might skip Animation event</li>
<li>Use auto transition to a fake after death state. Then use StateMachineBehaviour to detect when we exit the Death state. This is also a robust solution, but requires you to modify the structure of the Animator.</li>
</ul>
</li>
<li>
<p>How to transition out of a substate machine (<a href="https://www.youtube.com/watch?v=lpekqN4_4xg">Using substate machine</a>)</p>
<ul>
<li>Using Up node: Transition to state or StateMachine</li>
<li>Using Entry/Exit nodes: Transition to/from StateMachine. This facilitates better reusability</li>
<li>Try to only use one way</li>
</ul>
</li>
</ul>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>