<!DOCTYPE html>
<html lang="en">
<head>

        <title>Python Wats: Mutable Default Arguments</title>
        <meta charset="utf-8" />


        <!-- Mobile viewport optimized: j.mp/bplateviewport -->
        <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1">

        <link rel="stylesheet" type="text/css" href="./theme/gumby.css" />
        <link rel="stylesheet" type="text/css" href="./theme/style.css" />
        <link rel="stylesheet" type="text/css" href="./theme/pygment.css" />

        <script src="./theme/js/libs/modernizr-2.6.2.min.js"></script>






</head>

<body id="index" class="home">


    <div class="container">

        <div class="row">

          <header id="banner" class="body">
                  <h1><a href=".">Ha.Minh's Blog <strong></strong></a></h1>
          </header><!-- /#banner -->

            <div id="navigation" class="navbar row">
              <a href="#" gumby-trigger="#navigation &gt; ul" class="toggle"><i class="icon-menu"></i></a>
             
              <ul class="columns">
                <li><a href=".">Home</a></li>

                <li><a href="./pages/about.html">About</a></li>

              </ul>
            </div>

<section id="content" class="body">

   <div class="row">
        <div class="eleven columns">


            <header>
              <h2 class="entry-title">
                <a href="./python-wats-mutable-default-arguments.html" rel="bookmark"
                   title="Permalink to Python Wats: Mutable Default Arguments">Python Wats: Mutable Default Arguments</a></h2>
           
            </header>
            <footer class="post-info">
              <abbr class="published" title="2014-04-25T00:00:00">
                Fri 25 April 2014
              </abbr>
              <address class="vcard author">
                By <a class="url fn" href="./author/ha-minh.html">Ha Minh</a>
              </address>
            </footer><!-- /.post-info -->
            <div class="entry-content">
              <p>Let's look at a common Python <a href="https://www.destroyallsoftware.com/talks/wat">wat</a> and try to figure out wat's actually happening!  </p>
<p>We'll define a function, <code>foo</code>, which takes one argument, <code>l</code>, which has the default value of an empty list.</p>
<div class="codehilite"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">def</span> <span class="n">foo</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="p">[])</span><span class="o">:</span>
<span class="p">...</span>     <span class="n">l</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="err">&#39;</span><span class="n">cat</span><span class="err">&#39;</span><span class="p">)</span>
<span class="p">...</span>     <span class="k">return</span> <span class="n">l</span>
</pre></div>


<p>What happens when we call <code>foo</code> multiple times?</p>
<div class="codehilite"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">foo</span><span class="p">()</span>
<span class="p">[</span><span class="err">&#39;</span><span class="n">cat</span><span class="err">&#39;</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">foo</span><span class="p">()</span>
<span class="p">[</span><span class="err">&#39;</span><span class="n">cat</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">cat</span><span class="err">&#39;</span><span class="p">]</span>
</pre></div>


<p>Whoa! So mutating <code>l</code> actually mutates it for all future calls to the function. Weird.</p>
<p>This means that the <code>[]</code> object is <em>only created once</em>, and each time we call <code>foo</code> without an argument, <code>l</code> is referring to that same object. This may lead you to form a hypothesis: <code>l=[]</code> is kind of like a name-binding statement that executes only once, when the function is defined. </p>
<p>But, if that hypothesis is true, then how should we expect the following function to behave?</p>
<div class="codehilite"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">def</span> <span class="n">bar</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="p">[])</span><span class="o">:</span>
<span class="p">...</span>     <span class="n">print</span> <span class="n">locals</span><span class="p">()</span>
<span class="p">...</span>     <span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">cat</span><span class="err">&#39;</span><span class="p">]</span>
<span class="p">...</span>     <span class="k">return</span> <span class="n">l</span>
<span class="p">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="n">bar</span><span class="p">()</span>
<span class="cp"># ?</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bar</span><span class="p">()</span>
<span class="cp"># ?</span>
</pre></div>


<p>Well, if <code>l=[]</code> is <em>like a name-binding statement that executes only once</em> when the function is defined, then I would expect something like this sequence of events to happen, when we define <code>bar</code> and then call it twice:</p>
<ol>
<li><code>bar</code> is defined<ul>
<li>the name <code>l</code> is bound to the object <code>[]</code></li>
</ul>
</li>
<li><code>bar</code> is called the first time:<ul>
<li><code>locals()</code> should return <code>{l : []}</code></li>
<li>then we reassign <code>l</code> to <code>['cat']</code> within the scope of <code>bar</code></li>
<li><code>bar</code> should return <code>['cat']</code></li>
</ul>
</li>
<li><code>bar</code> is called again:<ul>
<li><code>l=[]</code> is not executed (based on our assumption)</li>
<li><code>locals()</code> should either return <code>{}</code> or <code>{l : ['cat']}</code>, depending on if the assignment of <code>l = ['cat']</code> persists after the function is called the first time</li>
<li><code>bar</code> should return <code>['cat']</code></li>
</ul>
</li>
</ol>
<p>What actually happens?</p>
<div class="codehilite"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">bar</span><span class="p">()</span>
<span class="p">{</span><span class="sc">&#39;l&#39;</span><span class="o">:</span> <span class="p">[]}</span>
<span class="p">[</span><span class="err">&#39;</span><span class="n">cat</span><span class="err">&#39;</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bar</span><span class="p">()</span>
<span class="p">{</span><span class="sc">&#39;l&#39;</span><span class="o">:</span> <span class="p">[]}</span>
<span class="p">[</span><span class="err">&#39;</span><span class="n">cat</span><span class="err">&#39;</span><span class="p">]</span>
</pre></div>


<p>Hrm. This behavior reasonably leads us to believe that the assignment <code>l=[]</code> happens <em>each time we call the function <code>bar</code></em>. But in <code>foo</code>, <code>l=[]</code> can't be a statement that executes each time the function is called, or else we'd create a new <code>[]</code> each time. </p>
<p>If we assume <code>l=[]</code> executes like a name-binding statement, then it must execute either (1) only once when the function is defined, or (2) each time the function is called. In <code>foo</code>, it only executes once, but in <code>bar</code>, it executes every time we call <code>bar</code>. That just can't be. So our assumption that <code>l=[]</code> executes like a name-binding statement leads to a contradiction, and thus must be wrong! </p>
<p>Guess what, nerds! We kind of just did a <a href="http://en.wikipedia.org/wiki/Proof_by_contradiction">proof by contradiction</a>!</p>
<p>So then what really happens when we define default values for arguments? Let's see if we can figure out where the default values are stored.</p>
<p>My usual go-to for questions like this is Python internals whiz and Hacker School Facilitator <a href="http://akaptur.github.io/">Allison Kaptur</a>, but you can also find the answer with a bit of <a href="https://www.google.com/webhp?sourceid=chrome-instant&amp;ion=1&amp;espv=2&amp;ie=UTF-8#q=python%20mutable%20default%20arguments">googling</a>. </p>
<p>So, without further ado, what actually happens when we define a default argument in Python 2.x is that the value of the argument gets stored inside the function's <code>func_defaults</code> method. (In 3.x, the values are stored in the <code>__defaults__</code> method.) </p>
<p>Let's look back at the <code>foo</code> function:</p>
<div class="codehilite"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">def</span> <span class="n">foo</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="p">[])</span><span class="o">:</span>
<span class="p">...</span>     <span class="n">l</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="err">&#39;</span><span class="n">cat</span><span class="err">&#39;</span><span class="p">)</span>
<span class="p">...</span>     <span class="k">return</span> <span class="n">l</span>
</pre></div>


<p>In Python 2.x, we can access <code>foo</code>'s <code>func_defaults</code> like so:</p>
<div class="codehilite"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">foo</span><span class="p">.</span><span class="n">func_defaults</span>
<span class="p">([],)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">foo</span><span class="p">()</span>
<span class="p">[</span><span class="err">&#39;</span><span class="n">cat</span><span class="err">&#39;</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">foo</span><span class="p">.</span><span class="n">func_defaults</span>
<span class="p">([</span><span class="err">&#39;</span><span class="n">cat</span><span class="err">&#39;</span><span class="p">],)</span>
</pre></div>


<p>Aha! So the actual object that is being stored as the default for <code>foo</code> is being modified when we call <code>foo</code>! For fun, let's see if we can mutate the default value from outside of the function:</p>
<div class="codehilite"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">foo</span><span class="p">.</span><span class="n">func_defaults</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">append</span><span class="p">(</span><span class="err">&#39;</span><span class="n">dragon</span><span class="err">&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">foo</span><span class="p">.</span><span class="n">func_defaults</span>
<span class="p">([</span><span class="err">&#39;</span><span class="n">cat</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">dragon</span><span class="err">&#39;</span><span class="p">],)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">foo</span><span class="p">()</span>
<span class="p">[</span><span class="err">&#39;</span><span class="n">cat</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">dragon</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">cat</span><span class="err">&#39;</span><span class="p">]</span>
</pre></div>


<p>Eep! That was fun. So what's in the <code>func_defaults</code> of <code>bar</code>? Recall:</p>
<div class="codehilite"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">def</span> <span class="n">bar</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="p">[])</span><span class="o">:</span>
<span class="p">...</span>     <span class="n">print</span> <span class="n">locals</span><span class="p">()</span>
<span class="p">...</span>     <span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">cat</span><span class="err">&#39;</span><span class="p">]</span>
<span class="p">...</span>     <span class="k">return</span> <span class="n">l</span>
</pre></div>


<p>And then:</p>
<div class="codehilite"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">bar</span><span class="p">.</span><span class="n">func_defaults</span>
<span class="p">([],)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bar</span><span class="p">()</span>
<span class="p">{</span><span class="sc">&#39;l&#39;</span><span class="o">:</span> <span class="p">[]}</span>
<span class="p">[</span><span class="err">&#39;</span><span class="n">cat</span><span class="err">&#39;</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bar</span><span class="p">.</span><span class="n">func_defaults</span> 
<span class="p">([],)</span>
</pre></div>


<p>Okay! So since <code>bar</code> <em>reassigns</em> <code>l</code> to <code>['cat']</code>, it doesn't modify the object stored in <code>func_defaults</code>.</p>
<p>So what have we learned?</p>
<p>It appears as if the following happens when we define and call <code>bar</code>:</p>
<ol>
<li><code>bar</code> is defined<ul>
<li>the object <code>[]</code> is created and stored in the <code>func_defaults</code> tuple</li>
</ul>
</li>
<li><code>bar</code> is called the first time:<ul>
<li>since we didn't pass in a value for <code>l</code> as an argument, Python looks in the <code>func_defaults</code> for the value to bind to the name <code>l</code>, and grabs the <code>[]</code> object that we created when we defined <code>bar</code></li>
<li><code>locals()</code> returns <code>{l : []}</code></li>
<li>we reassign <code>l</code> to <code>['cat']</code> within the scope of <code>bar</code>. Since this is a reassignment, this doesn't modify the <code>[]</code> object contained in <code>func_defaults</code>. Instead, <code>l</code> is just bound to a different object in memory.</li>
<li><code>['cat']</code> is returned</li>
</ul>
</li>
<li><code>bar</code> is called again:<ul>
<li>since we didn't modify the <code>[]</code> object the first time we called <code>bar</code>, the same series of events happens as in step 2!</li>
</ul>
</li>
</ol>
<p>I should probably also mention something more useful: a common way of setting a default value to an empty list (and having it actually work as expected) is to do the following:</p>
<div class="codehilite"><pre><span class="n">def</span> <span class="n">baz</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="n">None</span><span class="p">)</span><span class="o">:</span>
    <span class="k">if</span> <span class="n">not</span> <span class="n">l</span><span class="o">:</span>
        <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">l</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="err">&#39;</span><span class="n">cat</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">l</span>
</pre></div>


<p>When we call <code>baz</code> multiple times, its behavior is more expected:</p>
<div class="codehilite"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">baz</span><span class="p">()</span>
<span class="p">[</span><span class="err">&#39;</span><span class="n">cat</span><span class="err">&#39;</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">baz</span><span class="p">()</span>
<span class="p">[</span><span class="err">&#39;</span><span class="n">cat</span><span class="err">&#39;</span><span class="p">]</span>
</pre></div>


<p>Cool! Wat conquered. We should collect badges for all the wats we've battled.  </p>
<p>Thanks to <a href="http://maryrosecook.com/">Mary Rose Cook</a> and <a href="http://akaptur.github.io/">Allison Kaptur</a>, who valiantly battled this wat with me.</p>
            </div><!-- /.entry-content -->


        </div><!-- /.eleven.columns -->
        
<div class="three columns">

<h4>Pages</h4>

 <ul>
      <li><a href="./pages/about.html">About</a></li>
  </ul>

<h4>Categories</h4>
<ul>
		<li><a href="./category/articles.html">Articles</a></li>
</ul>


<h4>Tags</h4>
	<ul>
	    <li class="tag-4"><a href="./tag/python-internals.html">python internals</a></li>
	    <li class="tag-4"><a href="./tag/python.html">python</a></li>
</ul>


<nav class="widget">
  <h4>Social</h4>
  <ul>
    <li><a href="https://twitter.com/utsace">Twitter</a></li>
  </ul>
</nav>

</div> </div><!-- /.row -->


</section>

       </div><!-- /.row -->
    </div><!-- /.container -->


       <div class="container.nopad bg">

    
        <footer id="credits" class="row">
          <div class="seven columns left-center">

                   <address id="about" class="vcard body">
                    Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                    which takes great advantage of <a href="http://python.org">Python</a>.
                    <br />
                    Based on the <a target="_blank" href="http://gumbyframework.com">Gumby Framework</a>
                    </address>
          </div>


          <div class="seven columns">
            <div class="row">
              <ul class="socbtns">





              </ul>
            </div>
          </div>
        </footer>

    </div>


  <script src="./theme/js/libs/jquery-1.9.1.min.js"></script>
  <script src="./theme/js/libs/gumby.min.js"></script>
  <script src="./theme/js/plugins.js"></script>
</body>
</html>